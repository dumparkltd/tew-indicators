var Tabletop = require('tabletop').Tabletop
var log 		= require('debug')(':load-data')

var tabletop;
var data

var storeData = function(d){
  data = d
}

var waitForData = function(callback){
  if (data){
     callback(data);
  } else {
    setTimeout(function(){
      waitForData(callback);
    },250);
  }
}



module.exports = function (key, sheet, callback) {
  log('sheet ', sheet )
  return function () {    

    if (typeof tabletop === 'undefined'){
      tabletop = Tabletop.init({
        key: key,
        wanted:[sheet],
        callback:storeData,                
        prettyColumnNames :false,
        parseNumbers: true,
        proxy: "http://tewdata.s3.amazonaws.com",
      })
    } else {
      tabletop.addWanted(sheet)
    }
    waitForData(callback)    
  }
}
