var Tabletop = require('tabletop').Tabletop
var log 		= require('debug')(':load-data')

var tabletop;
var data

var storeData = function(d){
  data = d
}

var waitForData = function(callback){
  if (data){
     callback(data);
  } else {
    setTimeout(function(){
      waitForData(callback);
    },250);
  }
}



module.exports = function (args, callback) {
  log('sheet ', args.sheet )

  return function () {    

    if (typeof tabletop === 'undefined'){

      tabletop = Tabletop.init({
        key: args.key,
        wanted:[args.sheet],
        callback:storeData,                
        prettyColumnNames :false,
        parseNumbers: true,
        proxy: (args.isProxy && typeof args.bucket !== 'undefined') 
          ? 'http://'+args.bucket+'.s3.amazonaws.com' 
          : undefined
      })
      window.Tabletop = window.Tabletop || Tabletop
    } else {
      tabletop.addWanted(args.sheet)
    }
    waitForData(callback)    
  }
}