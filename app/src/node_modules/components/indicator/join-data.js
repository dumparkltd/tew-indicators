// lodash
var _         = require('lodash') //TODO swap out with custom build using lodash-cli

//logging
var log     = require('debug')('components:indicator:join-data')


module.exports = function (data, flux) {
  var dataSetIdToYearMap = {}
  var datasets = _(data)
    .map(function(d) {
      return d.data_set
    })
    .uniq()
    .map(function (datasetId) {
      return flux.stores.datasets.findOne({ id: datasetId })
    })
    .each(function (dataset) {
      dataSetIdToYearMap[dataset.id] = dataset['observation_date']
    })
    .sortByOrder(['observation_date'], [false] ) //descending
    .value()

  log('datasets', datasets)

  var mostRecentYear = datasets[0]['observation_date']
  var groupedByDataset = _.groupBy(data, 'data_set')

  return {
    mostRecentYear: mostRecentYear,
    dataSetIdToYearMap: dataSetIdToYearMap,
    groupedByDataset: groupedByDataset
  }
}
