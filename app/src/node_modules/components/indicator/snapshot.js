//main
var React       = require('react')


//components
var Select      	= require('react-select')
var TableHeader		= require('./table-header')
var TableRow			= require('./table-row')
var Button 				= require('react-bootstrap/lib/Button')
var ButtonToolbar	= require('react-bootstrap/lib/ButtonToolbar')

//helpers
var _ 					= require('lodash')

//logging
var log       	= require('debug')('components:indicator:snapshot')

var style = {
	filterControl: {
		marginLeft: 20
	},
}

module.exports = React.createClass({

	propTypes : {
		flux: React.PropTypes.object,
		params: React.PropTypes.object,
		query: React.PropTypes.object,
    data: React.PropTypes.array,
		datasets: React.PropTypes.array,
		breakdowns: React.PropTypes.array,
		indicator: React.PropTypes.object,
		dateOptions: React.PropTypes.array
	},

	getInitialState: function () {
		return {
			tableHeaderGroups: [
			'Breakdowns', 'Order', 'Show'
			]
		}
	},

  render: function () {
		log('props', this.props)
		var flux = this.props.flux
		var dateClassName
    var DateComponent

    //set DateComponent
		if (this.props.dateOptions.length > 1) {
			dateClassName = 'date-dropdown'
			DateComponent = (
				<Select
					name='indicator-date-dropdown'
					value={this.props.dateOptions[0].value}
					options={this.props.dateOptions} //TODO remove initial value from options ?
					onChange={this.handleDateSelect} />
			)
		}
		else {
			dateClassName = 'date-header'
			DateComponent = <h3>{this.props.dateOptions[0].label}</h3>
		}

		return (
			<div className='snapshot'>
				<ButtonToolbar className='filter-controls' style={style.filterControl}>
				 	{
						// _.map(this.props.breakdowns, function (breakdown) {
						// 	var style = breakdown.isActive ? { backgroundColor: '#337ab7' } : { backgroundColor: '#BDC3C7' }
						//
						// 	return (
						// 		<Button
						// 			style={style}
						// 			active={breakdown.isActive}
						// 			bsStyle='primary'
						// 			bsSize='large'
						// 			onClick={this.handleFilterToggle(breakdown.id)}
						// 			className={breakdown.id + '-filter'}>
						// 			{breakdown.title}
						// 		</Button>
						// 	)
						// }.bind(this))
					}
				</ButtonToolbar>
				<table className='table'>
	        <TableHeader breakdowns={this.props.breakdowns} tableHeaderGroups={this.state.tableHeaderGroups} />
					<tbody className='table-body'>
						{_.map(this.props.data, function (d) {
							log('d', d)
							return (
								<TableRow datum={d} />
							)
						}.bind(this))}
					</tbody>
				</table>
			</div>
  )
  },

	componentWillReceiveProps: function (nextProps) {
			this.setState({ shortToTitle: this.getShortToTitle(nextProps.dataGroups) })
	},

	handleDateSelect: function () {
		//TODO
	},

	handleFilterToggle: function (breakdownId) {
		return function () {
			this.props.flux.actions.indicator.toggleFilter(breakdownId)
		}.bind(this)
	},

	getShortToTitle: function (dataGroups) {
		var shortToTitle = {}
		_.each(dataGroups, function (dataGroup) {
			shortToTitle[dataGroup.short] = dataGroup.title
		})
		return shortToTitle
	}


})
