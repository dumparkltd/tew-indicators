var React         = require('react')
var Fluxxor       = require('fluxxor')
var FluxMixin     = Fluxxor.FluxMixin(React)
var Router        = require('react-router')

var RouteHandler  = Router.RouteHandler

//helpers
var pluck         = require('lodash.pluck')
var where         = require('lodash.where')
var find          = require('lodash.find')
var result        = require('lodash.result')
var capitalize    = require('capitalize')

var log       = require('debug')('src:components:issue')

function routeToTitle (route) {
  var regexp = /-/g
  return capitalize.words(route.substring(1).replace(regexp, ' '))
}

function titleToRoute (title) {
  var regexp = / /g
  return title.split(regexp).slice(0, 5).join('-').toLowerCase()
}


module.exports = React.createClass({
  mixins: [
    Fluxxor.FluxMixin(React),
  ],

//  propTypes: {
//    flux: React.PropTypes.object
//  },

render: function () {

  return (
    <div className='issue'>
      <h3>Issue</h3>
      <h2>{this.state.issue.title}</h2>
      <p>{this.state.issue.commentary}</p>
        {this.state.indicators.map(function (indicator) {
          log('indicator', indicator)

          return (
            <button onClick={this.handleIndicatorClick(indicator.slug)}>{indicator.title}</button>
          )
        }.bind(this))}
    </div>
  )
},

  getState : function (props){
    log('props', props)
    var flux = this.getFlux()
    var issue = flux.stores.issues.query({ slug: props.params.issueSlug })
    var indicators = flux.stores.indicators.query({ issue: issue.id })

    return {
      indicators: indicators,
      issueSlug : props.params.issueSlug,
      issue : issue
    }
  },

  getInitialState: function () {
    return this.getState(this.props);
  },
  componentWillReceiveProps: function (nextProps) {
    log('nextProps', nextProps)
    this.setState(this.getState(nextProps));
  },

  handleIndicatorClick: function (indicatorSlug) {
    return function (e) {
      this.getFlux().actions.indicator.select(indicatorSlug)
    }.bind(this)
  }
})
